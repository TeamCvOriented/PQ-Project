import os
import json
import logging
import asyncio
import time
import re
from typing import List, Dict, Any, Optional
from dotenv import load_dotenv
from openai import OpenAI

# åŠ è½½ç¯å¢ƒå˜é‡
load_dotenv()

logger = logging.getLogger(__name__)

class MockQuizGenerator:
    """
    æ¨¡æ‹Ÿé¢˜ç›®ç”Ÿæˆå™¨ï¼Œç”¨äºæµ‹è¯•å’Œå¤‡ç”¨
    """
    def __init__(self):
        pass
    
    def generate_quiz(self, text_content: str, num_questions: int = 5) -> List[Dict]:
        """
        ç”Ÿæˆé«˜è´¨é‡æ¨¡æ‹Ÿé¢˜ç›®
        """
        
        try:
            # åŸºäºæ–‡æœ¬å†…å®¹ç”Ÿæˆæ›´æœ‰æ·±åº¦çš„æ¨¡æ‹Ÿé¢˜ç›®
            mock_questions = []
            
            # é¢„è®¾ä¸€äº›æå…·æŒ‘æˆ˜æ€§çš„é¢˜ç›®æ¨¡æ¿
            question_templates = [
                {
                    "question": "å‡è®¾ä½ æ˜¯ä¸€ä¸ªè·¨å›½ä¼ä¸šçš„æˆ˜ç•¥é¡¾é—®ï¼Œéœ€è¦å°†æä¾›å†…å®¹ä¸­çš„æ ¸å¿ƒç†å¿µæ•´åˆåˆ°ä¸€ä¸ªæ­£é¢ä¸´æ•°å­—åŒ–è½¬å‹ã€ç›‘ç®¡æ”¿ç­–å˜åŒ–å’Œå…¨çƒä¾›åº”é“¾é‡æ„ä¸‰é‡æŒ‘æˆ˜çš„ä¼ ç»Ÿåˆ¶é€ ä¼ä¸šä¸­ã€‚åœ¨æœ‰é™çš„èµ„æºé¢„ç®—å’Œ18ä¸ªæœˆçš„æ—¶é—´çª—å£å†…ï¼Œä½ å¦‚ä½•è®¾è®¡ä¸€ä¸ªæ—¢èƒ½ä¿æŒç°æœ‰ä¸šåŠ¡ç¨³å®šæ€§ï¼Œåˆèƒ½å®ç°é•¿æœŸç«äº‰ä¼˜åŠ¿çš„è½¬å‹ç­–ç•¥ï¼Ÿè€ƒè™‘åˆ°ä¸åŒåˆ©ç›Šç›¸å…³è€…ï¼ˆè‚¡ä¸œã€å‘˜å·¥ã€å®¢æˆ·ã€ç›‘ç®¡æœºæ„ï¼‰çš„æœŸæœ›å†²çªï¼Œä½ çš„ç­–ç•¥é‡ç‚¹åº”è¯¥æ”¾åœ¨å“ªä¸ªç»´åº¦ï¼Ÿ",
                    "options": [
                        "ä¼˜å…ˆå»ºç«‹æ•æ·çš„ç»„ç»‡æ¶æ„å’Œè·¨éƒ¨é—¨åä½œæœºåˆ¶ï¼Œé€šè¿‡å†…éƒ¨èƒ½åŠ›å»ºè®¾é©±åŠ¨æ¸è¿›å¼åˆ›æ–°ï¼ŒåŒæ—¶å»ºç«‹é£é™©ç®¡æ§ä½“ç³»åº”å¯¹å¤–éƒ¨ä¸ç¡®å®šæ€§",
                        "é›†ä¸­èµ„æºè¿›è¡Œæ ¸å¿ƒæŠ€æœ¯çªç ´å’Œäº§å“åˆ›æ–°ï¼Œé€šè¿‡å·®å¼‚åŒ–ç«äº‰ä¼˜åŠ¿æŠµå¾¡å¸‚åœºå†²å‡»ï¼Œå»¶åç»„ç»‡å˜é©ä»¥é¿å…å†…éƒ¨åŠ¨è¡",
                        "åŠ å¿«å¤–éƒ¨åˆä½œä¼™ä¼´å…³ç³»å»ºè®¾ï¼Œé€šè¿‡ç”Ÿæ€ç³»ç»Ÿæ•´åˆè·å¾—å¿«é€Ÿè½¬å‹èƒ½åŠ›ï¼ŒåŒæ—¶ä¿æŒç°æœ‰è¿è¥æ¨¡å¼çš„ç¨³å®šæ€§",
                        "å…¨é¢æ¨è¿›æ•°å­—åŒ–åŸºç¡€è®¾æ–½å»ºè®¾ï¼Œä»¥æŠ€æœ¯å‡çº§å¸¦åŠ¨ä¸šåŠ¡æµç¨‹é‡ç»„ï¼Œé€šè¿‡æ•°æ®é©±åŠ¨å†³ç­–å®ç°ç²¾ç›Šè¿è¥"
                    ],
                    "correct_answer": 0,
                    "explanation": "åœ¨å¤šé‡æŒ‘æˆ˜å’Œèµ„æºçº¦æŸä¸‹ï¼Œå»ºç«‹æ•æ·ç»„ç»‡æ¶æ„æ˜¯æœ€å¯æŒç»­çš„é€‰æ‹©ã€‚é€‰é¡¹Aè€ƒè™‘äº†å†…å¤–éƒ¨å¹³è¡¡ã€çŸ­æœŸç¨³å®šä¸é•¿æœŸå‘å±•çš„æƒè¡¡ï¼Œä»¥åŠé£é™©ç®¡æ§çš„é‡è¦æ€§ã€‚é€‰é¡¹Bè¿‡äºæ¿€è¿›ï¼Œå¯èƒ½å¯¼è‡´èµ„æºåˆ†æ•£å’Œå†…éƒ¨ä¸ç¨³å®šï¼›é€‰é¡¹Cä¾èµ–å¤–éƒ¨èµ„æºå­˜åœ¨æ§åˆ¶é£é™©ï¼›é€‰é¡¹DæŠ€æœ¯å¯¼å‘å¿½ç•¥äº†äººæ–‡å› ç´ å’Œç»„ç»‡é€‚åº”æ€§ã€‚"
                },
                {
                    "question": "åœ¨ä¸€ä¸ªç”±å¤šä¸ªè‡ªä¸»å›¢é˜Ÿç»„æˆçš„å¤æ‚é¡¹ç›®ä¸­ï¼Œä½ å‘ç°å›¢é˜Ÿé—´å­˜åœ¨ä¿¡æ¯å­¤å²›ã€ç›®æ ‡å†²çªå’Œèµ„æºç«äº‰é—®é¢˜ã€‚åŸºäºæä¾›å†…å®¹çš„ç®¡ç†ç†å¿µï¼Œå¦‚æœä½ éœ€è¦è®¾è®¡ä¸€å¥—æ—¢èƒ½ä¿æŒå„å›¢é˜Ÿåˆ›æ–°æ´»åŠ›å’Œè‡ªä¸»æ€§ï¼Œåˆèƒ½ç¡®ä¿æ•´ä½“åè°ƒå’Œç›®æ ‡ä¸€è‡´çš„æ²»ç†æœºåˆ¶ï¼Œä½ ä¼šå¦‚ä½•å¹³è¡¡é›†ä¸­æ§åˆ¶ä¸åˆ†æ•£å†³ç­–ä¹‹é—´çš„å¼ åŠ›ï¼Ÿç‰¹åˆ«æ˜¯å½“é¢ä¸´ç´§æ€¥æƒ…å†µéœ€è¦å¿«é€Ÿå“åº”æ—¶ï¼Œè¿™å¥—æœºåˆ¶åº”è¯¥å¦‚ä½•åŠ¨æ€è°ƒæ•´ä»¥ç¡®ä¿æ•ˆç‡å’Œè´¨é‡ï¼Ÿ",
                    "options": [
                        "å»ºç«‹åˆ†å±‚å†³ç­–çŸ©é˜µå’ŒåŠ¨æ€æˆæƒæœºåˆ¶ï¼Œé€šè¿‡å…±äº«KPIä½“ç³»å’Œå®šæœŸåè°ƒä¼šè®®å®ç°è½¯æ€§æ•´åˆï¼Œç´§æ€¥æƒ…å†µä¸‹å¯åŠ¨ä¸´æ—¶æŒ‡æŒ¥ç»“æ„",
                        "å®æ–½ä¸¥æ ¼çš„ä¸­å¤®é›†æƒç®¡ç†ï¼Œé€šè¿‡ç»Ÿä¸€çš„æµç¨‹æ ‡å‡†å’Œç»©æ•ˆè€ƒæ ¸ç¡®ä¿ä¸€è‡´æ€§ï¼Œè®¾ç«‹ä¸“é—¨çš„åè°ƒéƒ¨é—¨å¤„ç†å›¢é˜Ÿé—´å†²çª",
                        "é‡‡ç”¨å®Œå…¨åˆ†æ•£çš„å¸‚åœºåŒ–æœºåˆ¶ï¼Œè®©å›¢é˜Ÿé—´é€šè¿‡å†…éƒ¨ç«äº‰å’Œåå•†è§£å†³å†²çªï¼Œç®¡ç†å±‚ä»…æä¾›èµ„æºæ”¯æŒå’Œæœ€ç»ˆä»²è£",
                        "æ„å»ºåŸºäºä»·å€¼è§‚å’Œæ–‡åŒ–è®¤åŒçš„è‡ªç»„ç»‡ç³»ç»Ÿï¼Œé€šè¿‡åŸ¹è®­å’Œæ¿€åŠ±æœºåˆ¶ä¿ƒè¿›è‡ªå‘åä½œï¼Œå‡å°‘æ­£å¼çš„ç®¡ç†å¹²é¢„"
                    ],
                    "correct_answer": 0,
                    "explanation": "é€‰é¡¹Aæä¾›äº†çµæ´»æ€§ä¸æ§åˆ¶çš„æœ€ä½³å¹³è¡¡ã€‚åˆ†å±‚å†³ç­–çŸ©é˜µä¿è¯äº†ä¸åŒå±‚çº§çš„é€‚å½“æˆæƒï¼Œå…±äº«KPIç¡®ä¿ç›®æ ‡ä¸€è‡´ï¼Œå®šæœŸåè°ƒç»´æŒä¿¡æ¯æµé€šï¼Œä¸´æ—¶æŒ‡æŒ¥ç»“æ„åº”å¯¹ç´§æ€¥æƒ…å†µã€‚é€‰é¡¹Bè¿‡äºåƒµåŒ–ï¼ŒæŠ‘åˆ¶åˆ›æ–°ï¼›é€‰é¡¹Cå¯èƒ½å¯¼è‡´æ··ä¹±å’Œä½æ•ˆï¼›é€‰é¡¹Dç†æƒ³åŒ–ï¼Œç¼ºä¹å¿…è¦çš„ç»“æ„æ”¯æ’‘ã€‚"
                },
                {
                    "question": "è€ƒè™‘ä¸€ä¸ªéœ€è¦åœ¨æŠ€æœ¯åˆ›æ–°ã€ç”¨æˆ·ä½“éªŒã€å•†ä¸šå¯æŒç»­æ€§å’Œç¤¾ä¼šè´£ä»»å››ä¸ªç»´åº¦é—´å¯»æ±‚å¹³è¡¡çš„äº§å“å†³ç­–åœºæ™¯ã€‚åŸºäºæä¾›å†…å®¹çš„æ ¸å¿ƒè§‚ç‚¹ï¼Œå½“è¿™å››ä¸ªç›®æ ‡ä¹‹é—´å‡ºç°æ ¹æœ¬æ€§å†²çªæ—¶ï¼ˆä¾‹å¦‚ï¼Œæœ€å…·åˆ›æ–°æ€§çš„æŠ€æœ¯æ–¹æ¡ˆå¯èƒ½æŸå®³ç”¨æˆ·éšç§ï¼Œæœ€ä½³ç”¨æˆ·ä½“éªŒå¯èƒ½é™ä½å•†ä¸šç›ˆåˆ©ï¼Œæœ€å¤§ç¤¾ä¼šæ•ˆç›Šå¯èƒ½å¢åŠ æˆæœ¬è´Ÿæ‹…ï¼‰ï¼Œä½ å¦‚ä½•æ„å»ºä¸€ä¸ªåŠ¨æ€æƒè¡¡æ¡†æ¶æ¥æŒ‡å¯¼å†³ç­–è¿‡ç¨‹ï¼Ÿè¿™ä¸ªæ¡†æ¶åº”è¯¥å¦‚ä½•å¤„ç†ä¸åŒæ—¶é—´å°ºåº¦ä¸Šçš„ä»·å€¼æƒè¡¡ï¼ˆçŸ­æœŸæ”¶ç›Švsé•¿æœŸå½±å“ï¼‰ï¼Ÿ",
                    "options": [
                        "å»ºç«‹å¤šç»´ä»·å€¼è¯„ä¼°çŸ©é˜µï¼Œç»“åˆåˆ©ç›Šç›¸å…³è€…å½±å“åˆ†æå’Œæ—¶é—´æŠ˜ç°æ¨¡å‹ï¼Œé€šè¿‡æƒ…æ™¯è§„åˆ’å’Œé£é™©è¯„ä¼°ç¡®å®šå„ç»´åº¦çš„åŠ¨æ€æƒé‡",
                        "é‡‡ç”¨å±‚æ¬¡åŒ–å†³ç­–æ ‘ï¼Œä»¥å•†ä¸šå¯æŒç»­æ€§ä¸ºæ ¸å¿ƒçº¦æŸæ¡ä»¶ï¼Œåœ¨æ­¤åŸºç¡€ä¸Šä¼˜åŒ–å…¶ä»–ä¸‰ä¸ªç»´åº¦çš„ç»„åˆæ–¹æ¡ˆ",
                        "è¿ç”¨å¾·å°”è²æ³•æ”¶é›†ä¸“å®¶æ„è§ï¼Œå»ºç«‹å›ºå®šçš„æƒé‡ä½“ç³»ï¼Œç„¶åé€šè¿‡æ ‡å‡†åŒ–è¯„åˆ†æ–¹æ³•å¯¹ä¸åŒæ–¹æ¡ˆè¿›è¡Œé‡åŒ–æ¯”è¾ƒ",
                        "å®æ–½æ•æ·è¯•é”™æ–¹æ³•ï¼Œé€šè¿‡å°è§„æ¨¡å®éªŒå¿«é€Ÿæµ‹è¯•ä¸åŒæƒè¡¡æ–¹æ¡ˆçš„æ•ˆæœï¼Œæ ¹æ®åé¦ˆåŠ¨æ€è°ƒæ•´ä¼˜å…ˆçº§"
                    ],
                    "correct_answer": 0,
                    "explanation": "é€‰é¡¹Aæä¾›äº†æœ€å…¨é¢å’Œç³»ç»Ÿçš„æ¡†æ¶ã€‚å¤šç»´è¯„ä¼°çŸ©é˜µè€ƒè™‘äº†å¤æ‚æ€§ï¼Œåˆ©ç›Šç›¸å…³è€…åˆ†æç¡®ä¿å…¬å¹³æ€§ï¼Œæ—¶é—´æŠ˜ç°å¤„ç†é•¿çŸ­æœŸæƒè¡¡ï¼Œæƒ…æ™¯è§„åˆ’åº”å¯¹ä¸ç¡®å®šæ€§ï¼ŒåŠ¨æ€æƒé‡ä¿æŒçµæ´»æ€§ã€‚é€‰é¡¹Bè¿‡äºç®€åŒ–ï¼Œå¯èƒ½å¿½è§†é‡è¦ä»·å€¼ï¼›é€‰é¡¹Cç¼ºä¹åŠ¨æ€æ€§å’Œæƒ…å¢ƒé€‚åº”æ€§ï¼›é€‰é¡¹Dè™½ç„¶çµæ´»ä½†å¯èƒ½ç¼ºä¹ç³»ç»Ÿæ€§æ€è€ƒã€‚"
                },
                {
                    "question": "åœ¨ä¸€ä¸ªå¿«é€Ÿå˜åŒ–çš„è¡Œä¸šç¯å¢ƒä¸­ï¼Œä½ è´Ÿè´£é¢†å¯¼ä¸€ä¸ªè·¨æ–‡åŒ–ã€è·¨ä¸“ä¸šçš„è™šæ‹Ÿå›¢é˜Ÿæ‰§è¡Œä¸€ä¸ªå…·æœ‰é«˜åº¦ä¸ç¡®å®šæ€§çš„åˆ›æ–°é¡¹ç›®ã€‚å›¢é˜Ÿæˆå‘˜åˆ†å¸ƒåœ¨ä¸åŒæ—¶åŒºï¼Œå…·æœ‰ä¸åŒçš„å·¥ä½œä¹ æƒ¯ã€æ²Ÿé€šé£æ ¼å’Œé£é™©åå¥½ã€‚åŸºäºæä¾›å†…å®¹çš„é¢†å¯¼åŠ›ç†å¿µï¼Œå½“é¡¹ç›®é­é‡é‡å¤§æŒ«æŠ˜æˆ–æ–¹å‘è°ƒæ•´æ—¶ï¼Œä½ å¦‚ä½•åœ¨ç»´æŒå›¢é˜Ÿå‡èšåŠ›å’Œå£«æ°”çš„åŒæ—¶ï¼Œç¡®ä¿å¿«é€Ÿé€‚åº”å’Œé«˜è´¨é‡å†³ç­–ï¼Ÿç‰¹åˆ«æ˜¯å¦‚ä½•å¤„ç†å›¢é˜Ÿå†…éƒ¨å¯èƒ½å‡ºç°çš„æ–‡åŒ–å†²çªå’Œä¸“ä¸šåˆ†æ­§ï¼Ÿ",
                    "options": [
                        "å»ºç«‹å¤šå…ƒåŒ–çš„æ²Ÿé€šæ¸ é“å’Œæ–‡åŒ–æ¡¥æ¢æœºåˆ¶ï¼Œé€šè¿‡å…±åŒæ„¿æ™¯æ„å»ºå’Œé€‚åº”æ€§é¢†å¯¼é£æ ¼æ¥ç»Ÿä¸€å›¢é˜Ÿï¼Œç»“åˆæ•°æ®é©±åŠ¨å†³ç­–å’Œé›†ä½“æ™ºæ…§æ•´åˆå¤„ç†åˆ†æ­§",
                        "å®æ–½å¼ºåŠ¿çš„å˜é©ç®¡ç†ï¼Œé€šè¿‡æ˜ç¡®çš„æŒ‡ä»¤å’Œä¸¥æ ¼çš„æ‰§è¡Œç›‘æ§ç¡®ä¿å›¢é˜Ÿèšç„¦ï¼Œå°†æ–‡åŒ–å’Œä¸“ä¸šå·®å¼‚è§†ä¸ºéœ€è¦å…‹æœçš„éšœç¢",
                        "é‡‡ç”¨å®Œå…¨æ°‘ä¸»åŒ–çš„å†³ç­–è¿‡ç¨‹ï¼Œè®©æ‰€æœ‰å›¢é˜Ÿæˆå‘˜å¹³ç­‰å‚ä¸è®¨è®ºå’ŒæŠ•ç¥¨ï¼Œé€šè¿‡å¤šæ•°åŸåˆ™è§£å†³å†²çªå’Œåˆ†æ­§",
                        "å»ºç«‹å°ç»„è½®å²—åˆ¶åº¦ï¼Œè®©å›¢é˜Ÿæˆå‘˜ä½“éªŒä¸åŒçš„è§’è‰²å’Œæ–‡åŒ–ç¯å¢ƒï¼Œé€šè¿‡ç›¸äº’ç†è§£è‡ªç„¶åŒ–è§£å†²çª"
                    ],
                    "correct_answer": 0,
                    "explanation": "é€‰é¡¹Aä½“ç°äº†å¤æ‚ç¯å¢ƒä¸‹çš„é€‚åº”æ€§é¢†å¯¼ã€‚å¤šå…ƒåŒ–æ²Ÿé€šæ¸ é“é€‚åº”è™šæ‹Ÿå›¢é˜Ÿç‰¹ç‚¹ï¼Œæ–‡åŒ–æ¡¥æ¢æœºåˆ¶å¤„ç†è·¨æ–‡åŒ–æŒ‘æˆ˜ï¼Œå…±åŒæ„¿æ™¯æä¾›å‡èšåŠ›ï¼Œé€‚åº”æ€§é¢†å¯¼åº”å¯¹ä¸ç¡®å®šæ€§ï¼Œæ•°æ®é©±åŠ¨ç¡®ä¿å†³ç­–è´¨é‡ã€‚é€‰é¡¹Bå¿½è§†äº†å¤šå…ƒåŒ–çš„ä»·å€¼ï¼›é€‰é¡¹Cå¯èƒ½å¯¼è‡´å†³ç­–ä½æ•ˆå’Œè´¨é‡ä¸‹é™ï¼›é€‰é¡¹Dè™½æœ‰ä»·å€¼ä½†åœ¨ç´§æ€¥æƒ…å†µä¸‹ä¸å¤Ÿå®ç”¨ã€‚"
                }
            ]
            
            for i in range(min(num_questions, len(question_templates))):
                mock_questions.append(question_templates[i])
            
            # å¦‚æœéœ€è¦æ›´å¤šé¢˜ç›®ï¼Œç”Ÿæˆé¢å¤–çš„è¶…é«˜éš¾åº¦é¢˜ç›®
            if num_questions > len(question_templates):
                for i in range(num_questions - len(question_templates)):
                    additional_question = {
                        "question": f"ä½œä¸ºä¸€ä¸ªé¢ä¸´è¡Œä¸šé¢ è¦†æ€§å˜é©çš„ç»„ç»‡çš„é«˜çº§å†³ç­–è€…ï¼Œä½ éœ€è¦åŸºäºæä¾›å†…å®¹çš„ç¬¬{i+5}ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼Œè®¾è®¡ä¸€ä¸ªèƒ½å¤Ÿåœ¨èµ„æºçº¦æŸã€æ—¶é—´å‹åŠ›å’Œåˆ©ç›Šç›¸å…³è€…æœŸæœ›å†²çªçš„ç¯å¢ƒä¸‹ï¼Œæ—¢ä¿æŒç»„ç»‡ç¨³å®šæ€§åˆæ¨åŠ¨æˆ˜ç•¥è½¬å‹çš„ç»¼åˆæ–¹æ¡ˆã€‚è€ƒè™‘åˆ°å¸‚åœºä¸ç¡®å®šæ€§ã€æŠ€æœ¯æ¼”è¿›é€Ÿåº¦å’Œç»„ç»‡å˜é©é˜»åŠ›ï¼Œä½ å¦‚ä½•æ„å»ºä¸€ä¸ªåŠ¨æ€é€‚åº”çš„å®æ–½è·¯å¾„ï¼Ÿè¿™ä¸ªè·¯å¾„åº”è¯¥å¦‚ä½•åœ¨çŸ­æœŸç”Ÿå­˜éœ€æ±‚å’Œé•¿æœŸå‘å±•æ„¿æ™¯ä¹‹é—´æ‰¾åˆ°å¹³è¡¡ç‚¹ï¼ŒåŒæ—¶åº”å¯¹å¯èƒ½å‡ºç°çš„è¿é”ååº”å’Œæ„å¤–æŒ‘æˆ˜ï¼Ÿ",
                        "options": [
                            f"å»ºç«‹åŒè½¨å¹¶è¡Œçš„ç»„ç»‡æ¶æ„ï¼Œé€šè¿‡æ ¸å¿ƒä¸šåŠ¡ç»´ç¨³å’Œåˆ›æ–°ä¸šåŠ¡æ¢ç´¢çš„ç»„åˆï¼Œé…åˆæ¸è¿›å¼å˜é©ç®¡ç†å’ŒæŒç»­çš„é£é™©ç›‘æ§æœºåˆ¶",
                            f"é›†ä¸­èµ„æºè¿›è¡Œå…³é”®èƒ½åŠ›çªç ´ï¼Œé€šè¿‡æ¦‚å¿µ{i+5}çš„æ·±åº¦åº”ç”¨è·å¾—ç«äº‰ä¼˜åŠ¿ï¼Œå»¶ç¼“éæ ¸å¿ƒé¢†åŸŸçš„å˜é©ä»¥æ§åˆ¶é£é™©",
                            f"é‡‡ç”¨ç”Ÿæ€ç³»ç»Ÿæ•´åˆç­–ç•¥ï¼Œé€šè¿‡å¤–éƒ¨åˆä½œä¼™ä¼´ç½‘ç»œåˆ†æ•£é£é™©ï¼ŒåŒæ—¶ä¿æŒå†…éƒ¨ç»„ç»‡æ¶æ„çš„ç›¸å¯¹ç¨³å®š",
                            f"å®æ–½å…¨é¢æ•°å­—åŒ–è½¬å‹ï¼Œä»¥æŠ€æœ¯åˆ›æ–°é©±åŠ¨ä¸šåŠ¡æ¨¡å¼é‡æ„ï¼Œé€šè¿‡æ•°æ®åˆ†æå’Œäººå·¥æ™ºèƒ½ä¼˜åŒ–å†³ç­–è¿‡ç¨‹"
                        ],
                        "correct_answer": 0,
                        "explanation": f"åœ¨å¤æ‚å¤šå˜çš„ç¯å¢ƒä¸­ï¼ŒåŒè½¨å¹¶è¡Œæ¶æ„æ˜¯æœ€èƒ½å¹³è¡¡é£é™©ä¸æœºé‡çš„ç­–ç•¥ã€‚å®ƒæ—¢ä¿è¯äº†ç°æœ‰ä¸šåŠ¡çš„ç¨³å®šç°é‡‘æµï¼Œåˆä¸ºæœªæ¥å‘å±•å¼€è¾Ÿäº†æ¢ç´¢ç©ºé—´ã€‚è¿™ç§æ–¹æ³•è€ƒè™‘äº†ç»„ç»‡çš„é€‚åº”èƒ½åŠ›ã€èµ„æºçš„åˆç†é…ç½®ã€å˜é©çš„å¯æ§æ€§ä»¥åŠå¯¹ä¸ç¡®å®šæ€§çš„åº”å¯¹ã€‚å…¶ä»–é€‰é¡¹æˆ–è¿‡äºä¿å®ˆã€æˆ–é£é™©è¿‡é«˜ã€æˆ–è¿‡åº¦ä¾èµ–å¤–éƒ¨å› ç´ ã€‚"
                    }
                    mock_questions.append(additional_question)
            
            return mock_questions
            
        except Exception as e:
            logger.error(f"é«˜è´¨é‡æ¨¡æ‹Ÿé¢˜ç›®ç”Ÿæˆå¤±è´¥: {e}")
            return []

class QuizGenerator:
    def __init__(self):
        # åŠ è½½ç¯å¢ƒå˜é‡
        load_dotenv()
        
        # é…ç½® Qwen API
        self.api_key = os.getenv('QWEN_API_KEY')
        self.use_mock = False
        self.client = None
        self.mock_generator = MockQuizGenerator()  # ä¿ç•™ç”¨äºå†…éƒ¨æµ‹è¯•ï¼Œä½†ä¸åœ¨generate_quizä¸­ä½¿ç”¨
        
        if not self.api_key:
            error_msg = "é”™è¯¯: æœªæ‰¾åˆ°QWEN_API_KEYç¯å¢ƒå˜é‡ï¼Œæ— æ³•ä½¿ç”¨AIå‡ºé¢˜åŠŸèƒ½ã€‚è¯·é…ç½®æ­£ç¡®çš„APIå¯†é’¥ã€‚"
            print(error_msg)
            self.use_mock = True
            raise Exception(error_msg)
        else:
            try:
                # ä½¿ç”¨ OpenAI å…¼å®¹çš„ Qwen API
                self.client = OpenAI(
                    api_key=self.api_key,
                    base_url="https://dashscope.aliyuncs.com/compatible-mode/v1",
                )
                print("âœ… Qwen API é…ç½®æˆåŠŸï¼Œå·²å¯ç”¨é«˜éš¾åº¦AIå‡ºé¢˜åŠŸèƒ½")
            except Exception as e:
                error_msg = f"é”™è¯¯: Qwen API é…ç½®å¤±è´¥: {e}"
                print(error_msg)
                self.use_mock = True
                self.client = None
                raise Exception(error_msg)
    
    
    async def _generate_with_qwen_async(self, content_text: str, num_questions: int = 1) -> List[Dict]:
        """
        ä½¿ç”¨ Qwen API å¼‚æ­¥ç”Ÿæˆé¢˜ç›®ï¼ˆåŠ¨æ€è¶…æ—¶ï¼š75-300ç§’ï¼‰
        """
        if not self.client:
            raise Exception("Qwen API å®¢æˆ·ç«¯æœªåˆå§‹åŒ–")
        
        # æ„å»ºæç¤ºè¯
        # å¯¹äºè¶…é•¿å†…å®¹ï¼Œç»™AIä¸€äº›å¤„ç†å»ºè®®
        content_length = len(content_text)
        content_hint = ""
        if content_length > 80000:
            content_hint = f"\n\næ³¨æ„ï¼šå†…å®¹æå…¶åºå¤§ï¼ˆ{content_length}å­—ç¬¦ï¼‰ï¼Œè¯·æ·±åº¦åˆ†æå…¨æ–‡å†…å®¹ï¼Œä»ä¸­æç‚¼æœ€æ ¸å¿ƒçš„æ¦‚å¿µã€å…³é”®å®šä¹‰ã€é‡è¦ç†è®ºå’Œå®è·µè¦ç‚¹æ¥ç”Ÿæˆé«˜è´¨é‡çš„é¢˜ç›®ã€‚è¯·ç¡®ä¿é¢˜ç›®è¦†ç›–å†…å®¹çš„ç²¾åéƒ¨åˆ†ã€‚"
        elif content_length > 50000:
            content_hint = f"\n\næ³¨æ„ï¼šå†…å®¹éå¸¸åºå¤§ï¼ˆ{content_length}å­—ç¬¦ï¼‰ï¼Œè¯·å…¨é¢åˆ†ææ–‡æœ¬åï¼Œé‡ç‚¹å…³æ³¨æ ¸å¿ƒæ¦‚å¿µã€å…³é”®å®šä¹‰ã€é‡è¦ç†è®ºå’Œå…³é”®ä¿¡æ¯ç”Ÿæˆé«˜è´¨é‡é¢˜ç›®ã€‚"
        elif content_length > 30000:
            content_hint = f"\n\næ³¨æ„ï¼šå†…å®¹éå¸¸é•¿ï¼ˆ{content_length}å­—ç¬¦ï¼‰ï¼Œè¯·ä»”ç»†åˆ†æå…¨æ–‡åï¼Œé‡ç‚¹å…³æ³¨æ ¸å¿ƒæ¦‚å¿µã€å…³é”®å®šä¹‰å’Œé‡è¦ä¿¡æ¯ç”Ÿæˆé«˜è´¨é‡é¢˜ç›®ã€‚"
        elif content_length > 15000:
            content_hint = f"\n\næ³¨æ„ï¼šå†…å®¹è¾ƒé•¿ï¼ˆ{content_length}å­—ç¬¦ï¼‰ï¼Œè¯·é‡ç‚¹å…³æ³¨æ ¸å¿ƒæ¦‚å¿µå’Œå…³é”®ä¿¡æ¯ç”Ÿæˆé¢˜ç›®ã€‚"
        
        prompt = f"""
åŸºäºä»¥ä¸‹å†…å®¹ç”Ÿæˆ {num_questions} é“é«˜éš¾åº¦ã€æ·±å±‚æ€ç»´çš„é€‰æ‹©é¢˜ã€‚æ¯é“é¢˜æœ‰4ä¸ªé€‰é¡¹ï¼Œè¯·æ ‡æ˜æ­£ç¡®ç­”æ¡ˆåºå·ï¼ˆ0-3ï¼‰å’Œè¯¦ç»†è§£é‡Šã€‚

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¿”å›ï¼š
{{
    "questions": [
        {{
            "question": "é¢˜ç›®å†…å®¹",
            "options": ["é€‰é¡¹A", "é€‰é¡¹B", "é€‰é¡¹C", "é€‰é¡¹D"],
            "correct_answer": 0,
            "explanation": "ç­”æ¡ˆè§£é‡Š"
        }}
    ]
}}

é«˜éš¾åº¦å‡ºé¢˜è¦æ±‚ï¼ˆå¿…é¡»ä¸¥æ ¼éµå®ˆï¼‰ï¼š
1. é¢˜ç›®å¿…é¡»åŸºäºå†…å®¹è¿›è¡Œæ·±åº¦åˆ†æå’Œå¤šå±‚æ¨ç†ï¼ŒæŒ–æ˜éšå«çš„é€»è¾‘å…³ç³»å’Œæ·±å±‚å«ä¹‰
2. é¢˜ç›®é•¿åº¦è‡³å°‘4-5å¥è¯ï¼ŒåŒ…å«å¤æ‚çš„èƒŒæ™¯è®¾å®šã€å¤šé‡æ¡ä»¶é™åˆ¶å’Œå±‚æ¬¡åŒ–çš„é—®é¢˜é™ˆè¿°
3. ç»å¯¹ç¦æ­¢ä»»ä½•å½¢å¼çš„åŸæ–‡æ‘˜å½•ï¼Œæ‰€æœ‰é€‰é¡¹å¿…é¡»ç»è¿‡å¤æ‚æ¨ç†å’Œç»¼åˆåˆ†ææ‰èƒ½å¾—å‡º
4. æ¯ä¸ªé€‰é¡¹éƒ½è¦å…·æœ‰é«˜åº¦è¿·æƒ‘æ€§ï¼ŒåŸºäºçœŸå®çš„ç›¸å…³æ¦‚å¿µä½†å­˜åœ¨ç»†å¾®çš„é€»è¾‘é”™è¯¯æˆ–é€‚ç”¨èŒƒå›´å·®å¼‚
5. æ­£ç¡®ç­”æ¡ˆåºå·ä»0å¼€å§‹ï¼ˆ0=é€‰é¡¹Aï¼Œ1=é€‰é¡¹Bï¼Œ2=é€‰é¡¹Cï¼Œ3=é€‰é¡¹Dï¼‰ï¼Œä½†ç­”æ¡ˆä¸èƒ½è¿‡äºæ˜æ˜¾ï¼Œéœ€è¦æ·±å…¥æ€è€ƒæ‰èƒ½ç¡®å®š
6. è§£é‡Šå¿…é¡»è¯¦ç»†åˆ†ææ¯ä¸ªé€‰é¡¹çš„é€»è¾‘ï¼Œè¯´æ˜æ­£ç¡®ç­”æ¡ˆçš„æ·±å±‚åŸå› å’Œå…¶ä»–é€‰é¡¹çš„å…·ä½“é”™è¯¯æ‰€åœ¨
7. é¢˜ç›®å¿…é¡»æµ‹è¯•é«˜é˜¶è®¤çŸ¥èƒ½åŠ›ï¼šæ‰¹åˆ¤æ€§æ€ç»´ã€åˆ›æ–°åº”ç”¨ã€ç³»ç»Ÿåˆ†æã€æˆ˜ç•¥è¯„ä¼°ç­‰
8. é¿å…æ‰€æœ‰ç®€å•ç›´æ¥çš„è¡¨è¿°ï¼Œä½¿ç”¨å¤æ‚çš„æƒ…å¢ƒå‡è®¾ã€å¤šå˜é‡åˆ†æã€è·¨é¢†åŸŸåº”ç”¨ç­‰åœºæ™¯
9. é€‰é¡¹è¦ä½“ç°ä¸åŒçš„æ€ç»´è·¯å¾„å’Œè§£å†³æ–¹æ¡ˆï¼Œæ¯ä¸ªéƒ½æœ‰å…¶åˆç†æ€§ä½†åªæœ‰ä¸€ä¸ªæœ€ä¼˜
10. é¢˜ç›®åº”è¯¥è®©å³ä½¿ç†è§£äº†å†…å®¹çš„äººä¹Ÿéœ€è¦ä»”ç»†æ€è€ƒå’Œåˆ†ææ‰èƒ½ä½œç­”

**è§£é‡Šæ ¼å¼è¦æ±‚ï¼ˆé‡è¦ï¼‰ï¼š**
- åœ¨è§£é‡Šä¸­å¿…é¡»ä½¿ç”¨é€‰é¡¹å­—æ¯æ ‡è¯†ï¼šé€‰é¡¹Aã€é€‰é¡¹Bã€é€‰é¡¹Cã€é€‰é¡¹D
- ç¦æ­¢åœ¨è§£é‡Šä¸­ä½¿ç”¨æ•°å­—åºå·å¦‚é€‰é¡¹0ã€é€‰é¡¹1ã€é€‰é¡¹2ã€é€‰é¡¹3
- æ­£ç¡®çš„è§£é‡Šæ ¼å¼ï¼š"é€‰é¡¹Aæä¾›äº†æœ€å…¨é¢çš„è§£å†³æ–¹æ¡ˆ...é€‰é¡¹Bè™½ç„¶è€ƒè™‘äº†Xå› ç´ ï¼Œä½†å¿½ç•¥äº†Y...é€‰é¡¹Cçš„æ–¹æ³•è¿‡äºæ¿€è¿›...é€‰é¡¹Dç¼ºä¹å®ç”¨æ€§..."

ä¸¥æ ¼è¦æ±‚çš„é¢˜ç›®ç±»å‹ï¼ˆå¿…é¡»é€‰æ‹©ï¼‰ï¼š
- å¤šç»´å†³ç­–åˆ†æé¢˜ï¼šç»™å‡ºå¤æ‚çš„ç°å®åœºæ™¯ï¼Œè¦æ±‚æƒè¡¡å¤šä¸ªç›¸äº’å†²çªçš„å› ç´ åšå‡ºæœ€ä¼˜å†³ç­–
- ç³»ç»Ÿæ€§æ€ç»´é¢˜ï¼šåˆ†æå¤æ‚ç³»ç»Ÿä¸­çš„ç›¸äº’ä½œç”¨å…³ç³»ï¼Œé¢„æµ‹å¹²é¢„æªæ–½çš„è¿é”ååº”
- åˆ›æ–°åº”ç”¨é¢˜ï¼šå°†ç†è®ºæ¦‚å¿µåˆ›æ–°æ€§åœ°åº”ç”¨åˆ°å…¨æ–°çš„ã€è·¨é¢†åŸŸçš„å®é™…é—®é¢˜ä¸­
- æ‰¹åˆ¤æ€§è¯„ä¼°é¢˜ï¼šæ·±å…¥åˆ†ææŸç§æ–¹æ³•æˆ–ç†è®ºçš„é€‚ç”¨è¾¹ç•Œã€æ½œåœ¨é£é™©å’Œæ”¹è¿›æ–¹å‘
- ç­–ç•¥ä¼˜åŒ–é¢˜ï¼šåœ¨èµ„æºçº¦æŸå’Œå¤šé‡ç›®æ ‡å†²çªçš„æƒ…å†µä¸‹è®¾è®¡æœ€ä¼˜ç­–ç•¥
- å› æœé“¾åˆ†æé¢˜ï¼šåˆ†æå¤æ‚å› æœå…³ç³»ç½‘ç»œä¸­çš„å…³é”®èŠ‚ç‚¹å’Œæ æ†ç‚¹
- ä»·å€¼åˆ¤æ–­é¢˜ï¼šåœ¨ä»·å€¼è§‚å†²çªçš„æƒ…å¢ƒä¸‹è¿›è¡Œé“å¾·æ¨ç†å’Œåˆ©ç›Šæƒè¡¡

å‡ºé¢˜ç¤ºä¾‹æ€è·¯ï¼š
- ä¸è¦é—®"ä»€ä¹ˆæ˜¯X"ï¼Œè€Œè¦é—®"åœ¨Yæƒ…å†µä¸‹ï¼Œå¦‚ä½•è¿ç”¨XåŸç†è§£å†³Zé—®é¢˜ï¼ŒåŒæ—¶å…¼é¡¾Aã€Bã€Cä¸‰ä¸ªçº¦æŸæ¡ä»¶"
- ä¸è¦é—®"Xæœ‰ä»€ä¹ˆç‰¹ç‚¹"ï¼Œè€Œè¦é—®"å½“Xæ–¹æ³•åœ¨ç‰¹å®šç¯å¢ƒä¸‹å¤±æ•ˆæ—¶ï¼Œåº”è¯¥å¦‚ä½•è°ƒæ•´ç­–ç•¥ä»¥è¾¾åˆ°é¢„æœŸç›®æ ‡"
- ä¸è¦é—®"Xå’ŒYçš„åŒºåˆ«"ï¼Œè€Œè¦é—®"åœ¨é¢ä¸´Pé—®é¢˜æ—¶ï¼Œé€‰æ‹©Xè¿˜æ˜¯Yæ–¹æ³•æ›´åˆé€‚ï¼Œéœ€è¦è€ƒè™‘å“ªäº›æ·±å±‚å› ç´ "

åªè¿”å›JSONï¼Œä¸è¦å…¶ä»–æ–‡å­—ã€‚ç¡®ä¿æ¯é“é¢˜éƒ½éœ€è¦æ·±åº¦æ€è€ƒå’Œå¤šæ­¥æ¨ç†æ‰èƒ½è§£ç­”ã€‚

å†…å®¹ï¼š
{content_text}{content_hint}


"""
        
        try:
            # è®¡ç®—è°ƒè¯•ä¿¡æ¯
            content_length = len(content_text)
            prompt_length = len(prompt)
            system_msg = 'You are a world-class expert in advanced educational assessment, specializing in creating extremely challenging questions that test the highest levels of cognitive ability. Your questions require deep analytical thinking, complex reasoning, strategic decision-making, and synthesis of multiple concepts. You create questions that even experts in the field would need to carefully consider. Focus on scenarios that involve multiple competing priorities, ethical dilemmas, strategic trade-offs, and complex real-world applications. Always respond with valid JSON format. IMPORTANT: In explanations, always refer to options using letters (é€‰é¡¹A, é€‰é¡¹B, é€‰é¡¹C, é€‰é¡¹D) never use numbers (é€‰é¡¹0, é€‰é¡¹1, é€‰é¡¹2, é€‰é¡¹3).'
            system_msg_length = len(system_msg)
            
            # ä¼°ç®—tokenæ•°é‡ (ä¸­æ–‡çº¦1.5-2å­—ç¬¦=1tokenï¼Œè‹±æ–‡çº¦4å­—ç¬¦=1token)
            estimated_input_tokens = int(content_length * 0.6 + prompt_length * 0.6 + system_msg_length * 0.25)
            
            print(f"ğŸ” è°ƒè¯•ä¿¡æ¯:")
            print(f"   ğŸ“„ è¾“å…¥å†…å®¹é•¿åº¦: {content_length:,} å­—ç¬¦")
            print(f"   ğŸ“ Prompté•¿åº¦: {prompt_length:,} å­—ç¬¦") 
            print(f"   ğŸ¤– ç³»ç»Ÿæ¶ˆæ¯é•¿åº¦: {system_msg_length:,} å­—ç¬¦")
            print(f"   ğŸ”¢ ä¼°ç®—è¾“å…¥Tokenæ•°: {estimated_input_tokens:,} tokens")
            print(f"   âš™ï¸  æ¨¡å‹å‚æ•°: temperature={0.9}, max_tokens={4000}")
            print(f"   ğŸ¯ è¯·æ±‚é¢˜ç›®æ•°é‡: {num_questions}")
            
            # ä½¿ç”¨ Qwen API ç”Ÿæˆå†…å®¹
            response = self.client.chat.completions.create(
                model="qwen-plus",  # ä½¿ç”¨qwen-plusæ¨¡å‹
                messages=[
                    {'role': 'system', 'content': system_msg},
                    {'role': 'user', 'content': prompt}
                ],
                temperature=0.9,  # è¿›ä¸€æ­¥æé«˜åˆ›é€ æ€§
                max_tokens=4000,  # å¢åŠ tokené™åˆ¶ä»¥æ”¯æŒæ›´å¤æ‚çš„é¢˜ç›®
                timeout=60.0  # å¢åŠ åˆ°60ç§’è¶…æ—¶ï¼Œä¸ºæ•´ä½“åŠ¨æ€è¶…æ—¶ç•™å‡ºå……åˆ†ç¼“å†²
            )
            
            response_text = response.choices[0].message.content
            
            # è®¡ç®—å“åº”ä¿¡æ¯
            response_length = len(response_text)
            estimated_output_tokens = int(response_length * 0.6)  # ä¼°ç®—è¾“å‡ºtoken
            
            print(f"âœ… Qwen API è°ƒç”¨æˆåŠŸ")
            print(f"   ğŸ“¤ è¿”å›å†…å®¹é•¿åº¦: {response_length:,} å­—ç¬¦")
            print(f"   ğŸ”¢ ä¼°ç®—è¾“å‡ºTokenæ•°: {estimated_output_tokens:,} tokens")
            print(f"   ğŸ“Š æ€»ä¼°ç®—Tokenæ¶ˆè€—: {estimated_input_tokens + estimated_output_tokens:,} tokens")
            
            # å¦‚æœAPIè¿”å›usageä¿¡æ¯ï¼Œæ‰“å°å®é™…tokenä½¿ç”¨é‡
            if hasattr(response, 'usage') and response.usage:
                usage = response.usage
                print(f"   âœ¨ å®é™…Tokenä½¿ç”¨é‡:")
                if hasattr(usage, 'prompt_tokens'):
                    print(f"      - è¾“å…¥tokens: {usage.prompt_tokens:,}")
                if hasattr(usage, 'completion_tokens'):
                    print(f"      - è¾“å‡ºtokens: {usage.completion_tokens:,}")
                if hasattr(usage, 'total_tokens'):
                    print(f"      - æ€»è®¡tokens: {usage.total_tokens:,}")
            
            return self._parse_response(response_text)
            
        except Exception as e:
            logger.error(f"Qwen APIè°ƒç”¨å¤±è´¥: {e}")
            raise e
    
    def generate_quiz(self, content_text: str, num_questions: int = 1) -> List[Dict]:
        """
        æ ¹æ®å†…å®¹æ–‡æœ¬ç”Ÿæˆé€‰æ‹©é¢˜ï¼ˆåŠ¨æ€è¶…æ—¶ï¼š75-300ç§’ï¼‰
        å¼ºåˆ¶ä½¿ç”¨Qwen APIï¼Œä¸å†ä½¿ç”¨æ¨¡æ‹Ÿç”Ÿæˆå™¨
        
        Args:
            content_text: æºå†…å®¹æ–‡æœ¬
            num_questions: è¦ç”Ÿæˆçš„é¢˜ç›®æ•°é‡
            
        Returns:
            åŒ…å«é¢˜ç›®ä¿¡æ¯çš„å­—å…¸åˆ—è¡¨
        """
        # æ£€æŸ¥Qwen APIæ˜¯å¦å¯ç”¨
        if self.use_mock or not self.client:
            raise Exception("Qwen API æœªé…ç½®æˆ–ä¸å¯ç”¨ï¼Œæ— æ³•ç”Ÿæˆé¢˜ç›®ã€‚è¯·æ£€æŸ¥ QWEN_API_KEY ç¯å¢ƒå˜é‡é…ç½®ã€‚")
        
        # å¼ºåˆ¶ä½¿ç”¨çœŸå®çš„ Qwen API (åŠ¨æ€è¶…æ—¶ï¼š75-300ç§’)
        print("ğŸ”„ æ­£åœ¨ä½¿ç”¨ Qwen API ç”Ÿæˆé«˜éš¾åº¦é¢˜ç›®...")
        start_time = time.time()
        
        # ä½¿ç”¨å¼‚æ­¥æ–¹å¼å¤„ç†è¶…æ—¶
        loop = asyncio.new_event_loop()
        asyncio.set_event_loop(loop)
        
        try:
            # æ ¹æ®å†…å®¹é•¿åº¦åŠ¨æ€è°ƒæ•´è¶…æ—¶æ—¶é—´
            content_length = len(content_text)
            if content_length > 100000:
                timeout_seconds = 300.0  # å·¨å‹å†…å®¹ä½¿ç”¨5åˆ†é’Ÿè¶…æ—¶
                print(f"ğŸ“„ æ£€æµ‹åˆ°å·¨å‹å†…å®¹ï¼ˆ{content_length}å­—ç¬¦ï¼‰ï¼Œä½¿ç”¨300ç§’è¶…æ—¶...")
            elif content_length > 80000:
                timeout_seconds = 240.0  # æå¤§å†…å®¹ä½¿ç”¨4åˆ†é’Ÿè¶…æ—¶
                print(f"ğŸ“„ æ£€æµ‹åˆ°æå¤§å†…å®¹ï¼ˆ{content_length}å­—ç¬¦ï¼‰ï¼Œä½¿ç”¨240ç§’è¶…æ—¶...")
            elif content_length > 50000:
                timeout_seconds = 180.0  # è¶…è¶…é•¿å†…å®¹ä½¿ç”¨3åˆ†é’Ÿè¶…æ—¶
                print(f"ğŸ“„ æ£€æµ‹åˆ°è¶…è¶…é•¿å†…å®¹ï¼ˆ{content_length}å­—ç¬¦ï¼‰ï¼Œä½¿ç”¨180ç§’è¶…æ—¶...")
            elif content_length > 30000:
                timeout_seconds = 150.0  # è¶…é•¿å†…å®¹ä½¿ç”¨2.5åˆ†é’Ÿè¶…æ—¶
                print(f"ğŸ“„ æ£€æµ‹åˆ°è¶…é•¿å†…å®¹ï¼ˆ{content_length}å­—ç¬¦ï¼‰ï¼Œä½¿ç”¨150ç§’è¶…æ—¶...")
            elif content_length > 20000:
                timeout_seconds = 120.0  # å¾ˆé•¿å†…å®¹ä½¿ç”¨2åˆ†é’Ÿè¶…æ—¶
                print(f"ğŸ“„ æ£€æµ‹åˆ°å¾ˆé•¿å†…å®¹ï¼ˆ{content_length}å­—ç¬¦ï¼‰ï¼Œä½¿ç”¨120ç§’è¶…æ—¶...")
            elif content_length > 10000:
                timeout_seconds = 90.0  # é•¿å†…å®¹ä½¿ç”¨1.5åˆ†é’Ÿè¶…æ—¶
                print(f"ğŸ“„ æ£€æµ‹åˆ°é•¿å†…å®¹ï¼ˆ{content_length}å­—ç¬¦ï¼‰ï¼Œä½¿ç”¨90ç§’è¶…æ—¶...")
            else:
                timeout_seconds = 75.0  # æ™®é€šå†…å®¹ä½¿ç”¨75ç§’è¶…æ—¶
            
            # è®¾ç½®åŠ¨æ€è¶…æ—¶
            result = loop.run_until_complete(
                asyncio.wait_for(
                    self._generate_with_qwen_async(content_text, num_questions),
                    timeout=timeout_seconds
                )
            )
            
            elapsed_time = time.time() - start_time
            print(f"âœ… Qwen API è°ƒç”¨æˆåŠŸï¼Œè€—æ—¶: {elapsed_time:.2f}ç§’")
            return result
            
        except asyncio.TimeoutError:
            elapsed_time = time.time() - start_time
            error_msg = f"Qwen API è°ƒç”¨è¶…æ—¶ï¼ˆ{elapsed_time:.1f}ç§’ï¼‰ï¼Œè¯·ç¨åé‡è¯•æˆ–æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚"
            print(f"â° {error_msg}")
            raise Exception(error_msg)
            
        except Exception as e:
            error_msg = f"Qwen APIè°ƒç”¨å¤±è´¥: {str(e)}"
            print(f"âŒ {error_msg}")
            raise Exception(error_msg)
            
        finally:
            loop.close()

    
    def _parse_response(self, response_text: str) -> List[Dict]:
        """è§£æ Qwen API è¿”å›çš„å“åº”"""
        try:
            print(f"ğŸ” å¼€å§‹è§£æAPIå“åº”...")
            print(f"   ğŸ“„ åŸå§‹å“åº”é•¿åº¦: {len(response_text):,} å­—ç¬¦")
            
            # æ¸…ç†å“åº”æ–‡æœ¬
            cleaned_text = response_text.strip()
            
            # å°è¯•æå–JSONéƒ¨åˆ†
            json_match = re.search(r'```json\s*(.*?)\s*```', cleaned_text, re.DOTALL)
            if json_match:
                json_str = json_match.group(1).strip()
                print(f"   âœ… åœ¨markdownä»£ç å—ä¸­æ‰¾åˆ°JSON")
            else:
                # å¯»æ‰¾èŠ±æ‹¬å·åŒ…å›´çš„JSON
                brace_match = re.search(r'\{.*\}', cleaned_text, re.DOTALL)
                if brace_match:
                    json_str = brace_match.group(0)
                    print(f"   âœ… åœ¨æ–‡æœ¬ä¸­æ‰¾åˆ°JSONå¯¹è±¡")
                else:
                    json_str = cleaned_text
                    print(f"   âš ï¸  ç›´æ¥ä½¿ç”¨åŸå§‹æ–‡æœ¬ä½œä¸ºJSON")
            
            print(f"   ğŸ“ æå–çš„JSONé•¿åº¦: {len(json_str):,} å­—ç¬¦")
            
            # è§£æJSON
            data = json.loads(json_str)
            print(f"   âœ… JSONè§£ææˆåŠŸ")
            
            # ç¡®ä¿è¿”å›çš„æ˜¯æ–°æ ¼å¼çš„é¢˜ç›®åˆ—è¡¨
            if isinstance(data, dict) and 'questions' in data:
                questions = data['questions']
                print(f"   ğŸ“‹ å‘ç°questionså­—æ®µï¼ŒåŒ…å« {len(questions)} é“é¢˜ç›®")
            elif isinstance(data, list):
                questions = data
                print(f"   ğŸ“‹ ç›´æ¥å‘ç°é¢˜ç›®åˆ—è¡¨ï¼ŒåŒ…å« {len(questions)} é“é¢˜ç›®")
            else:
                raise ValueError("å“åº”æ ¼å¼ä¸æ­£ç¡®")
            
            print(f"   ğŸ” å¼€å§‹éªŒè¯å’Œæ ¼å¼åŒ–é¢˜ç›®...")
            
            # è½¬æ¢ä¸ºç»Ÿä¸€æ ¼å¼
            result = []
            for i, q in enumerate(questions):
                print(f"   ğŸ“ å¤„ç†ç¬¬ {i+1} é“é¢˜ç›®...")
                if isinstance(q, dict) and 'question' in q:
                    formatted_q = {
                        'question': q.get('question', ''),
                        'options': q.get('options', []),
                        'correct_answer': q.get('correct_answer', 0),
                        'explanation': q.get('explanation', ''),
                        'difficulty': q.get('difficulty', 'medium'),
                        'time_estimate': q.get('time_estimate', 20)
                    }
                    
                    # éªŒè¯é¢˜ç›®å†…å®¹
                    question_len = len(formatted_q['question'])
                    options_count = len(formatted_q['options'])
                    explanation_len = len(formatted_q['explanation'])
                    
                    print(f"      - é¢˜ç›®é•¿åº¦: {question_len} å­—ç¬¦")
                    print(f"      - é€‰é¡¹æ•°é‡: {options_count}")
                    print(f"      - æ­£ç¡®ç­”æ¡ˆ: é€‰é¡¹{chr(65+formatted_q['correct_answer'])}")
                    print(f"      - è§£é‡Šé•¿åº¦: {explanation_len} å­—ç¬¦")
                    
                    # ç¡®ä¿é€‰é¡¹æ˜¯åˆ—è¡¨æ ¼å¼
                    if not isinstance(formatted_q['options'], list):
                        print(f"      âš ï¸  é€‰é¡¹æ ¼å¼ä¸æ­£ç¡®ï¼Œå°è¯•ä¿®å¤...")
                        formatted_q['options'] = [
                            q.get('option_a', 'é€‰é¡¹A'),
                            q.get('option_b', 'é€‰é¡¹B'),
                            q.get('option_c', 'é€‰é¡¹C'),
                            q.get('option_d', 'é€‰é¡¹D')
                        ]
                    
                    result.append(formatted_q)
                    print(f"      âœ… ç¬¬ {i+1} é“é¢˜ç›®å¤„ç†å®Œæˆ")
                else:
                    print(f"      âŒ ç¬¬ {i+1} é“é¢˜ç›®æ ¼å¼é”™è¯¯ï¼Œè·³è¿‡")
            
            if not result:
                raise ValueError("æœªèƒ½è§£æå‡ºæœ‰æ•ˆé¢˜ç›®")
                
            total_questions = len(result)
            avg_question_length = sum(len(q['question']) for q in result) / total_questions if total_questions > 0 else 0
            avg_explanation_length = sum(len(q['explanation']) for q in result) / total_questions if total_questions > 0 else 0
            
            print(f"ğŸ“Š è§£æå®Œæˆç»Ÿè®¡:")
            print(f"   âœ… æˆåŠŸè§£æ {total_questions} é“é¢˜ç›®")
            print(f"   ğŸ“ å¹³å‡é¢˜ç›®é•¿åº¦: {avg_question_length:.1f} å­—ç¬¦")
            print(f"   ğŸ“ å¹³å‡è§£é‡Šé•¿åº¦: {avg_explanation_length:.1f} å­—ç¬¦")
            
            return result
            
        except json.JSONDecodeError as e:
            print(f"âŒ JSONè§£æå¤±è´¥: {e}")
            print(f"åŸå§‹å“åº”å‰200å­—ç¬¦: {response_text[:200]}...")
            return []
        except Exception as e:
            print(f"âŒ è§£æAIå“åº”å¤±è´¥: {e}")
            print(f"åŸå§‹å“åº”å‰200å­—ç¬¦: {response_text[:200]}...")
            return []
